---
title: "PM566 Final Project"
author: "Jiqing Wu"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---
<br>

This is my PM566 final project. 

<br>


```{r setup, message=FALSE, echo=FALSE, warning=FALSE}
knitr::opts_chunk$set(include  = TRUE)
#install.packages("sqldf")
library(sqldf)
library(ggplot2)
library(tidyr)
library(data.table)
library(tidyverse)
library(leaflet)
library(dplyr)
library(dtplyr)
library(plotly)
library(knitr)
library(DT)
# install.packages(c("RSQLite", "DBI"))
library(RSQLite)
library(DBI)
# Initialize a temporary in memory database
con <- dbConnect(SQLite(), ":memory:")
opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  eval=TRUE,
  echo = TRUE,
  fig.width = 7, 
  fig.align = 'center',
  fig.asp = 0.618,
  out.width = "700px")
load("/Users/jiqingwu/Desktop/566 Introduction to Health Data Science/midterm/Arrest2010.rda")
load("/Users/jiqingwu/Desktop/566 Introduction to Health Data Science/midterm/Arrest2019.rda")

dbWriteTable(con, "Arrest2010", Arrest2010)
dbWriteTable(con, "Arrest2019", Arrest2019)
```

<br>

# I. Brief Description 

In this project, I used the dataset which reflects arrest incidents in the City of Los Angeles from 2010 to 2019. There are 1,320,000 rows in this dataset, each row represents an arrest. The analysis is trying to figure out whether there is a difference between the number of arrest incidents in the City of Los Angeles from 2010 to 2019 and whether there are any relationship between subject age and sex, area, time and arrest type in the arrest situation in 2019. The graphs below focus on five main variables which represent subject age, subject sex, patrol divisions location and the type of charge the individual was arrested for repectively.

<br>



# II. Interactive Visualizations 

```{r echo=FALSE}
data1<-sqldf(
'SELECT "Arrest.Type", "Area.Name",
  AVG(Age) AS avg_Age,
  AVG(time_imp) AS avg_time
FROM Arrest2019
GROUP BY "Arrest.Type",  "Area.Name"')
```

```{r echo=FALSE}
data2<-sqldf(
'SELECT  COUNT(*) AS count,"Arrest.Type", "Area.Name"
FROM Arrest2019
GROUP BY "Arrest.Type",  "Area.Name"')
data3<- cbind(data1,data2$count)
```

<br>

## 1. Barchart

<br>

```{r echo=FALSE}
data2010<-sqldf(
'SELECT  COUNT(*) AS count, "Area.Name", "Date"
FROM Arrest2010
GROUP BY  "Area.Name"')

data2019<-sqldf(
'SELECT  COUNT(*) AS count, "Area.Name", "Date"
FROM Arrest2019
GROUP BY  "Area.Name"')
```

```{r echo=FALSE}
text2010=paste( paste("Area: ", data2010$Area.Name, sep=""), paste("Total Count: ", data2010$count, sep=""), sep = "<br>")

text2019=paste( paste("Area: ", data2019$Area.Name, sep=""), paste("Total Count: ", data2019$count, sep=""), sep = "<br>")

fig1 <- plot_ly(data2010, x = ~Area.Name, y = ~count, type = 'bar', text = text2010, marker = list(color = 'rgb(158,202,225)',line = list(color = 'rgb(8,48,107)', width = 1.5)),name = '2010')
fig1 <- fig1 %>% add_trace(data2019, x = ~data2019$Area.Name, y = ~data2019$count, text = text2019, marker = list(color = 'rgb(58,200,225)',line = list(color = 'rgb(8,48,107)', width = 1.5)), name = '2019')
fig1 <- fig1 %>% layout(yaxis = list(title = 'Count'), xaxis = list(title = 'patrol divisions location'),barmode = 'group', title="Difference between 2010 and 2019")

fig1
```

The Barchart shows the total number of arrest cases in each area in 2010 and 2019. The number of cases in each area in Los Angeles in 2019 seems to be less than that in 2010.

<br>

## 2. Scatter Plot

<br>

```{r echo=FALSE}
fig2<-data3 %>% 
plot_ly(x = ~Arrest.Type, y = ~avg_Age, 
        color = ~Area.Name, type = "scatter", mode = "markers", 
        size = ~`data2$count`, sizes = c(5, 50), marker = list(sizemode='diameter', opacity=0.5),
        hoverinfo = 'text',
        colors = "Blues",
        text = ~paste( paste("Average Age: ", avg_Age, sep=""), 
                       paste("Arrest Type: ", Arrest.Type, sep=""), 
                       paste("Arrest Area: ", Area.Name, sep=""), 
                       paste("Total Count: ", `data2$count`, sep=""), 
                       sep = "<br>")
        ) %>% layout(title = "Number of cases and average age of arrest type in each area in 2019", yaxis=list(title = "Average Age"), xaxis = list(title = "Arrest Type"))
        
fig2
```

The scatter plot shows number of cases and average age of subjects. The size indicates the number of cases, larger size means there is more cases. The area is indicates by color.

<br>

## 3. Boxplot 

<br>

```{r echo=FALSE}
fig3 <- plot_ly(Arrest2019, x = ~Arrest.Type, y = ~Age, color = ~Sex.Code, type = "box")
fig3 <- fig3 %>% layout(boxmode = "group", title = "Age by sex and arrest type", xaxis=list(title = "Arrest Type"))

fig3
```

The boxplot shows age in different arrest type and sex more clearly. It seems that males are older than females in most arrest type. People who are arrested because of dependent reason seem to be youngest. 

<br>

## 4. Histogram

<br>

```{r echo=FALSE}
Dependent<-sqldf(
'SELECT  Age,"Arrest.Type"
FROM Arrest2019
WHERE "Arrest.Type"="Dependent"')

Felony<-sqldf(
'SELECT  Age,"Arrest.Type"
FROM Arrest2019
WHERE "Arrest.Type"="Felony"')

Infraction<-sqldf(
'SELECT  Age,"Arrest.Type"
FROM Arrest2019
WHERE "Arrest.Type"="Infraction"')

Misdemeanor<-sqldf(
'SELECT  Age,"Arrest.Type"
FROM Arrest2019
WHERE "Arrest.Type"="Misdemeanor"')

Other<-sqldf(
'SELECT  Age,"Arrest.Type"
FROM Arrest2019
WHERE "Arrest.Type"="Other"')

fig4 <- plot_ly(alpha = 0.3)
fig4 <- fig4 %>% add_histogram(x = ~Dependent$Age, name="Dependent")
fig4 <- fig4 %>% add_histogram(x = ~Felony$Age, name="Felony")
fig4 <- fig4 %>% add_histogram(x = ~Infraction$Age, name="Infraction")
fig4 <- fig4 %>% add_histogram(x = ~Misdemeanor$Age, name="Misdemeanor")
fig4 <- fig4 %>% add_histogram(x = ~Other$Age, name="Other")
fig4 <- fig4 %>% layout(barmode = "overlay",title = "Age by arrest type", xaxis=list(title = "Age", yaxis=list(title="Count")))

fig4
```

The histogram shows that the age range are overlap and the age of most subjects are concentrated at 25 to 28 in most arrest type.

<br>

## 5. Table

<br>

```{r echo=FALSE}
data7<-sqldf(
'SELECT  COUNT(*) AS Cases, "Area.Name", "Arrest.Date", "Arrest.Type","Sex.Code","PartOfDay"
FROM Arrest2019
GROUP BY  "Arrest.Date", "Area.Name", "Arrest.Type","Sex.Code","PartOfDay"')

table1 <- data7  %>% select(Arrest.Date,Cases,Area.Name,Arrest.Type,Sex.Code,PartOfDay)
datatable(table1)
```

The table above is an interactive datatable which shows the total count of cases grouped by arrest date, arrest time, patrol divisions location, arrest type and sex.

<br>


# IV. Conclusion
-The number of cases in each area in Los Angeles in 2019 seems to be less than that in 2010.
-Subject age seems to be affected by arrest type, although there are some overlaps.
-Males tend to be older than females.
-Subject age seems to be different in different patrol divisions.

<br>

# III. Link to the PDF version of the report 

https://github.com/jiqingwu1997/PM566_Final/raw/main/report%20.pdf

<br>
